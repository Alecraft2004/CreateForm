<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Crear Encuesta</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .tab-btn.active { background:#0d6efd; color:#fff }
    .question-card{border:1.5px solid #e3e3e3;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.04);margin-bottom:1.5rem}
    .option-input{width:90%}
    .icon-btn{background:none;border:none;color:#6c757d;font-size:1.1rem;margin-left:.5rem}
    .icon-btn:hover{color:#0d6efd}
    .fab{position:fixed;right:24px;bottom:24px;z-index:10}
    .side-toolbar{position:fixed;right:24px;top:120px;display:flex;flex-direction:column;gap:.5rem;z-index:10}
    .side-toolbar .btn{width:44px;height:44px;display:flex;align-items:center;justify-content:center}
    .answer-preview{opacity:.7}
    .opcion-correcta{outline:1px dashed #198754}
  </style>
</head>
<body>
  <nav class="navbar navbar-light bg-white border-bottom">
    <div class="container-fluid">
      <a class="btn btn-outline-secondary" href="/encuestas"><i class="bi bi-x-lg"></i> Cerrar</a>
      <span class="navbar-brand mx-auto fw-bold" id="titulo-navbar">Crear Formulario</span>
      <button class="btn btn-primary" type="submit" form="formulario" id="btn-guardar"><i class="bi bi-check-lg"></i> Crear</button>
    </div>
  </nav>

  <div class="container mt-4" style="max-width:760px;">
    <ul class="nav nav-tabs mb-3">
      <li class="nav-item"><button class="nav-link tab-btn active" id="tab-preguntas" onclick="mostrarTab('preguntas')"><i class="bi bi-list-ul me-1"></i>Preguntas</button></li>
      <li class="nav-item"><button class="nav-link tab-btn" id="tab-respuestas" onclick="mostrarTab('respuestas')"><i class="bi bi-bar-chart me-1"></i>Respuestas</button></li>
    </ul>

    <form id="formulario">
      <div id="tab-contenido-preguntas">
        <div class="mb-4">
          <input id="titulo-form" type="text" class="form-control form-control-lg mb-2" placeholder="Formulario sin título" name="titulo">
          <textarea id="descripcion-form" class="form-control" rows="2" placeholder="Descripción" name="descripcion"></textarea>
        </div>

        <div id="preguntas-lista"></div>
      </div>

      <div id="tab-contenido-respuestas" style="display:none;">
        <div class="alert alert-info text-center">Aquí se mostrarán las respuestas cuando el formulario esté activo.</div>
      </div>
    </form>
  </div>

  <div class="side-toolbar d-none d-md-flex">
    <button type="button" class="btn btn-light border" title="Añadir pregunta" onclick="agregarPregunta()"><i class="bi bi-plus-lg"></i></button>
    <button type="button" class="btn btn-light border" title="Título y descripción" onclick="scrollToTop()"><i class="bi bi-textarea-t"></i></button>
  </div>

  <button type="button" class="btn btn-primary rounded-circle shadow fab d-md-none" onclick="agregarPregunta()" title="Añadir pregunta">
    <i class="bi bi-plus-lg"></i>
  </button>

  <!-- Templates -->
  <template id="tpl-pregunta">
    <div class="question-card p-3" data-question>
      <div class="d-flex gap-2 mb-3 align-items-start">
        <input type="text" class="form-control" placeholder="Pregunta sin título" data-q-text>
        <select class="form-select" style="width:220px" data-q-tipo>
          <option value="opcion_multiple" selected>Opción múltiple</option>
          <option value="casillas">Casillas de verificación</option>
          <option value="desplegable">Desplegable</option>
          <option value="corta">Respuesta corta</option>
          <option value="parrafo">Párrafo</option>
        </select>
      </div>

      <div data-q-cuerpo>
        <!-- Se rellena según el tipo -->
      </div>

      <div class="d-flex justify-content-end align-items-center mt-2 gap-2">
        <div class="form-check form-switch me-auto">
          <input class="form-check-input" type="checkbox" role="switch" data-q-requerido>
          <label class="form-check-label">Obligatoria</label>
        </div>
        <button type="button" class="icon-btn" title="Duplicar pregunta" data-q-duplicar><i class="bi bi-files"></i></button>
        <button type="button" class="icon-btn" title="Eliminar pregunta" data-q-eliminar><i class="bi bi-trash"></i></button>
      </div>
    </div>
  </template>

  <template id="tpl-opciones">
    <div>
      <div class="mb-2" data-opciones>
        <!-- filas de opción -->
      </div>
      <button type="button" class="btn btn-sm btn-outline-secondary" data-agregar-opcion>
        <i class="bi bi-plus-lg me-1"></i>Agregar opción
      </button>
      <div class="form-text mt-2">Sugerencia: añade "Otros" si corresponde.</div>
    </div>
  </template>

  <template id="tpl-opcion-fila">
    <div class="d-flex align-items-center mb-2 p-1 rounded" data-opcion-fila data-correcta="false">
      <span class="me-2" data-opcion-icono>◯</span>
      <input type="text" class="form-control option-input" placeholder="Opción" data-opcion-texto>
      <button type="button" class="icon-btn" title="Marcar correcta" data-opcion-correct-toggle><i class="bi bi-check-circle"></i></button>
      <button type="button" class="icon-btn" title="Eliminar opción" data-opcion-eliminar><i class="bi bi-x-lg"></i></button>
    </div>
  </template>

  <template id="tpl-corta">
    <input type="text" class="form-control answer-preview" placeholder="Respuesta corta" disabled>
  </template>
  <template id="tpl-parrafo">
    <textarea class="form-control answer-preview" rows="3" placeholder="Respuesta larga" disabled></textarea>
  </template>

  <script>
    function mostrarTab(tab){
      document.getElementById('tab-contenido-preguntas').style.display = tab==='preguntas'?'':'none';
      document.getElementById('tab-contenido-respuestas').style.display = tab==='respuestas'?'':'none';
      document.getElementById('tab-preguntas').classList.toggle('active',tab==='preguntas');
      document.getElementById('tab-respuestas').classList.toggle('active',tab==='respuestas');
    }

    function scrollToTop(){ window.scrollTo({top:0, behavior:'smooth'}); }

    const elLista = document.getElementById('preguntas-lista');

    function clonarTemplate(id){
      return document.getElementById(id).content.firstElementChild.cloneNode(true);
    }

    function renderizarCuerpoSegunTipo(card){
      const tipo = card.querySelector('[data-q-tipo]').value;
      const cont = card.querySelector('[data-q-cuerpo]');
      cont.innerHTML = '';
      if (tipo === 'corta') {
        cont.appendChild(clonarTemplate('tpl-corta'));
      } else if (tipo === 'parrafo') {
        cont.appendChild(clonarTemplate('tpl-parrafo'));
      } else if (tipo === 'opcion_multiple' || tipo === 'casillas' || tipo === 'desplegable') {
        const bloque = clonarTemplate('tpl-opciones');
        const contOpc = bloque.querySelector('[data-opciones]');
        // crear 2 opciones por defecto
        agregarOpcionFila(contOpc, tipo);
        agregarOpcionFila(contOpc, tipo);
        // botón agregar
        bloque.querySelector('[data-agregar-opcion]').addEventListener('click', ()=> agregarOpcionFila(contOpc, tipo));
        cont.appendChild(bloque);
      }
      aplicarReglasCorrectas(card);
    }

    function agregarOpcionFila(contOpc, tipo){
      const fila = clonarTemplate('tpl-opcion-fila');
      const icono = fila.querySelector('[data-opcion-icono]');
      icono.textContent = tipo==='casillas' ? '☐' : (tipo==='desplegable' ? '⋮' : '◯');
      // eliminar
      fila.querySelector('[data-opcion-eliminar]').addEventListener('click', ()=>{
        fila.remove();
      });
      // marcar correcta
      const btnCorrect = fila.querySelector('[data-opcion-correct-toggle]');
      btnCorrect.addEventListener('click', ()=>{
        const card = fila.closest('[data-question]');
        const tipoActual = card.querySelector('[data-q-tipo]').value;
        const icon = btnCorrect.querySelector('i');
        const activar = fila.dataset.correcta !== 'true';
        // actualizar estado visual
        fila.dataset.correcta = activar ? 'true' : 'false';
        fila.classList.toggle('bg-success-subtle', activar);
        fila.classList.toggle('opcion-correcta', activar);
        icon.classList.toggle('bi-check-circle-fill', activar);
        icon.classList.toggle('text-success', activar);

        if (activar && (tipoActual === 'desplegable' || tipoActual === 'casillas')){
          // solo una correcta: desactivar el resto
          fila.parentElement.querySelectorAll('[data-opcion-fila]').forEach(otra=>{
            if (otra !== fila){
              otra.dataset.correcta = 'false';
              otra.classList.remove('bg-success-subtle','opcion-correcta');
              const i2 = otra.querySelector('[data-opcion-correct-toggle] i');
              if (i2){
                i2.classList.remove('bi-check-circle-fill','text-success');
              }
            }
          });
        }
      });
      contOpc.appendChild(fila);
    }

    function enlazarEventosCard(card){
      card.querySelector('[data-q-tipo]').addEventListener('change', ()=> {
        renderizarCuerpoSegunTipo(card);
        aplicarReglasCorrectas(card);
      });
      card.querySelector('[data-q-duplicar]').addEventListener('click', ()=>{
        const nueva = crearCardPregunta();
        nueva.querySelector('[data-q-text]').value = card.querySelector('[data-q-text]').value;
        // copiar tipo y opciones si aplica
        const tipoSel = card.querySelector('[data-q-tipo]').value;
        nueva.querySelector('[data-q-tipo]').value = tipoSel;
        renderizarCuerpoSegunTipo(nueva);
        if (tipoSel!=='corta' && tipoSel!=='parrafo'){
          const srcOpc = card.querySelectorAll('[data-opcion-fila]');
          const dstCont = nueva.querySelector('[data-opciones]');
          dstCont.innerHTML = '';
          srcOpc.forEach(o=>{
            const fila = clonarTemplate('tpl-opcion-fila');
            fila.querySelector('[data-opcion-texto]').value = o.querySelector('[data-opcion-texto]').value;
            fila.querySelector('[data-opcion-icono]').textContent = tipoSel==='casillas' ? '☐' : (tipoSel==='desplegable' ? '⋮' : '◯');
            // eventos eliminar y correcta
            fila.querySelector('[data-opcion-eliminar]').addEventListener('click', ()=> fila.remove());
            const btnCorrect = fila.querySelector('[data-opcion-correct-toggle]');
            const esCorrecta = o.dataset.correcta === 'true' || o.classList.contains('opcion-correcta');
            if (esCorrecta){
              fila.dataset.correcta = 'true';
              fila.classList.add('bg-success-subtle','opcion-correcta');
              const i2 = btnCorrect.querySelector('i');
              i2.classList.add('bi-check-circle-fill','text-success');
            }
            btnCorrect.addEventListener('click', ()=>{
              const card2 = fila.closest('[data-question]');
              const tipoActual = card2.querySelector('[data-q-tipo]').value;
              const icon = btnCorrect.querySelector('i');
              const activar = fila.dataset.correcta !== 'true';
              fila.dataset.correcta = activar ? 'true' : 'false';
              fila.classList.toggle('bg-success-subtle', activar);
              fila.classList.toggle('opcion-correcta', activar);
              icon.classList.toggle('bi-check-circle-fill', activar);
              icon.classList.toggle('text-success', activar);
              if (activar && (tipoActual === 'desplegable' || tipoActual === 'casillas')){
                fila.parentElement.querySelectorAll('[data-opcion-fila]').forEach(otra=>{
                  if (otra !== fila){
                    otra.dataset.correcta = 'false';
                    otra.classList.remove('bg-success-subtle','opcion-correcta');
                    const i3 = otra.querySelector('[data-opcion-correct-toggle] i');
                    if (i3){ i3.classList.remove('bi-check-circle-fill','text-success'); }
                  }
                });
              }
            });
            dstCont.appendChild(fila);
          });
        }
        card.after(nueva);
      });
      card.querySelector('[data-q-eliminar]').addEventListener('click', ()=>{
        card.remove();
      });
    }

    function crearCardPregunta(){
      const card = clonarTemplate('tpl-pregunta');
      renderizarCuerpoSegunTipo(card);
      enlazarEventosCard(card);
      return card;
    }

    function agregarPregunta(){
      elLista.appendChild(crearCardPregunta());
      setTimeout(()=> elLista.lastElementChild.scrollIntoView({behavior:'smooth', block:'center'}), 50);
    }

    // Inicialización: una pregunta por defecto y manejo de envío
    document.addEventListener('DOMContentLoaded', async ()=>{
      const idEditar = (new URLSearchParams(window.location.search)).get('id');
      if (idEditar){
        const tituloNav = document.getElementById('titulo-navbar');
        if (tituloNav) tituloNav.textContent = 'Editar Formulario';
        const btn = document.getElementById('btn-guardar');
        if (btn) btn.innerHTML = '<i class="bi bi-check-lg"></i> Guardar';
        try{
          const r = await fetch(`/api/encuestas/${idEditar}`);
          if(!r.ok) throw new Error('No se pudo cargar la encuesta');
          const data = await r.json();
          document.getElementById('titulo-form').value = data.titulo || '';
          document.getElementById('descripcion-form').value = data.descripcion || '';
          elLista.innerHTML = '';
          (data.preguntas || []).forEach(q=>{
            const card = crearCardPregunta();
            card.querySelector('[data-q-text]').value = q.texto || '';
            card.querySelector('[data-q-tipo]').value = q.tipo || 'opcion_multiple';
            renderizarCuerpoSegunTipo(card);
            card.querySelector('[data-q-requerido]').checked = !!q.requerida;
            if (q.tipo !== 'corta' && q.tipo !== 'parrafo'){
              const cont = card.querySelector('[data-opciones]');
              cont.innerHTML = '';
              (q.opciones || []).forEach(op=>{
                agregarOpcionFila(cont, q.tipo);
                const fila = cont.lastElementChild;
                if (!fila) return;
                const input = fila.querySelector('[data-opcion-texto]');
                if (input) input.value = op.texto || '';
                if (op.correcta){
                  fila.dataset.correcta = 'true';
                  fila.classList.add('bg-success-subtle','opcion-correcta');
                  const icon = fila.querySelector('[data-opcion-correct-toggle] i');
                  if (icon){ icon.classList.add('bi-check-circle-fill','text-success'); }
                }
              });
            }
            elLista.appendChild(card);
          });
        }catch(err){
          console.error(err);
          alert('Error cargando la encuesta: ' + err.message);
        }
      } else {
        agregarPregunta();
      }

      document.getElementById('formulario').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const datos = {
          titulo: document.getElementById('titulo-form').value || 'Formulario sin título',
          descripcion: document.getElementById('descripcion-form').value || '',
          esVotacion: false,
          preguntas: []
        };
        document.querySelectorAll('[data-question]').forEach(card=>{
          const tipo = card.querySelector('[data-q-tipo]').value;
          const q = {
            texto: card.querySelector('[data-q-text]').value || 'Pregunta',
            tipo,
            requerida: card.querySelector('[data-q-requerido]').checked,
            opciones: []
          };
          if (tipo!=='corta' && tipo!=='parrafo'){
            card.querySelectorAll('[data-opcion-fila]').forEach(f=>{
              const txt = f.querySelector('[data-opcion-texto]').value.trim();
              if (!txt) return;
              const correcta = f.dataset.correcta === 'true' || f.classList.contains('opcion-correcta');
              q.opciones.push({ texto: txt, correcta });
            });
            // Regla: en desplegable/casillas, solo 1 correcta
            if (tipo === 'desplegable' || tipo === 'casillas'){
              let marcada = false;
              q.opciones = q.opciones.map(o=>{
                if (o.correcta && !marcada){ marcada = true; return o; }
                return { ...o, correcta: false };
              });
            }
          }
          datos.preguntas.push(q);
        });
        try{
          const url = idEditar ? `/api/encuestas/${idEditar}` : '/api/encuestas';
          const method = idEditar ? 'PUT' : 'POST';
          const resp = await fetch(url,{
            method,
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify(datos)
          });
          if(!resp.ok){
            const txt = await resp.text();
            throw new Error(txt || 'Error al guardar');
          }
          if (idEditar){
            alert('Encuesta actualizada correctamente');
          } else {
            const id = await resp.json();
            alert('Encuesta creada con ID: ' + id);
          }
          window.location.href = '/encuestas';
        }catch(err){
          console.error(err);
          alert('No se pudo guardar la encuesta: ' + err.message);
        }
      });
    });

    function aplicarReglasCorrectas(card){
      const tipo = card.querySelector('[data-q-tipo]').value;
      if (!(tipo === 'desplegable' || tipo === 'casillas')) return;
      const filas = card.querySelectorAll('[data-opcion-fila]');
      let primera = true;
      filas.forEach(f=>{
        const es = f.dataset.correcta === 'true' || f.classList.contains('opcion-correcta');
        if (es && primera){
          primera = false;
        } else {
          // desmarcar extra
          f.dataset.correcta = 'false';
          f.classList.remove('bg-success-subtle','opcion-correcta');
          const i = f.querySelector('[data-opcion-correct-toggle] i');
          if (i){ i.classList.remove('bi-check-circle-fill','text-success'); }
        }
      });
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
