<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Crear Votación</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="estilos.css">
  <style>
    .tab-btn.active { background:#198754; color:#fff }
    .question-card{border:1.5px solid #e3e3e3;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.04);margin-bottom:1.5rem}
    .option-input{width:90%}
    .icon-btn{background:none;border:none;color:#6c757d;font-size:1.1rem;margin-left:.5rem}
    .icon-btn:hover{color:#198754}
  </style>
</head>
<body>
  <nav class="navbar navbar-light bg-white border-bottom">
    <div class="container-fluid">
      <a class="btn btn-outline-success" href="/votaciones"><i class="bi bi-x-lg"></i> Cerrar</a>
      <span class="navbar-brand mx-auto fw-bold">Crear Votación</span>
      <button class="btn btn-success" type="submit" form="formulario"><i class="bi bi-check-lg"></i> Crear</button>
    </div>
  </nav>

  <div class="container mt-4" style="max-width:760px;">
    <ul class="nav nav-tabs mb-3">
      <li class="nav-item"><button class="nav-link tab-btn active" id="tab-preguntas" onclick="mostrarTab('preguntas')"><i class="bi bi-list-ul me-1"></i>Opciones</button></li>
      <li class="nav-item"><button class="nav-link tab-btn" id="tab-respuestas" onclick="mostrarTab('respuestas')"><i class="bi bi-bar-chart me-1"></i>Resultados</button></li>
    </ul>

    <form id="formulario">
      <div id="tab-contenido-preguntas">
        <div class="mb-4">
          <input id="titulo-vot" type="text" class="form-control form-control-lg mb-2" placeholder="Votación sin título" name="titulo">
          <textarea id="descripcion-vot" class="form-control" rows="2" placeholder="Descripción" name="descripcion"></textarea>
        </div>

        <div class="question-card p-3" id="votacion-card">
          <div class="d-flex gap-2 mb-3 align-items-start">
            <input type="text" class="form-control" placeholder="Pregunta o asunto de la votación" id="texto-pregunta">
            <select class="form-select" style="width:220px" id="tipo-voto">
              <option value="unica" selected>Respuesta única</option>
              <option value="multiple">Selección múltiple</option>
            </select>
          </div>

          <div id="opciones-contenedor"></div>

          <div class="mt-2">
            <button type="button" class="btn btn-sm btn-outline-success" id="agregar-opcion">
              <i class="bi bi-plus-lg me-1"></i>Agregar opción
            </button>
          </div>

          <div class="form-check form-switch mt-3">
            <input class="form-check-input" type="checkbox" id="requerida">
            <label class="form-check-label" for="requerida">Obligatoria</label>
          </div>
        </div>
      </div>

      <div id="tab-contenido-respuestas" style="display:none;">
        <div class="alert alert-info text-center">Aquí se mostrarán los resultados cuando la votación esté activa.</div>
      </div>
    </form>
  </div>

  <template id="tpl-opcion-fila">
    <div class="d-flex align-items-center mb-2" data-opcion-fila>
      <span class="me-2" data-opcion-icono>◯</span>
      <input type="text" class="form-control option-input" placeholder="Opción" data-opcion-texto>
      <button type="button" class="icon-btn" title="Eliminar opción" data-opcion-eliminar><i class="bi bi-x-lg"></i></button>
    </div>
  </template>

  <script>
    function mostrarTab(tab){
      document.getElementById('tab-contenido-preguntas').style.display = tab==='preguntas'?'':'none';
      document.getElementById('tab-contenido-respuestas').style.display = tab==='respuestas'?'':'none';
      document.getElementById('tab-preguntas').classList.toggle('active',tab==='preguntas');
      document.getElementById('tab-respuestas').classList.toggle('active',tab==='respuestas');
    }

    const contOpc = document.getElementById('opciones-contenedor');
    const tipoSelect = document.getElementById('tipo-voto');

    function clonarTemplate(id){
      return document.getElementById(id).content.firstElementChild.cloneNode(true);
    }

    function agregarOpcionFila(){
      const fila = clonarTemplate('tpl-opcion-fila');
      aplicarIconoTipo(fila);
      fila.querySelector('[data-opcion-eliminar]').addEventListener('click', ()=>{
        fila.remove();
      });
      contOpc.appendChild(fila);
    }

    function aplicarIconoTipo(fila){
      const icono = fila.querySelector('[data-opcion-icono]');
      const tipo = tipoSelect.value;
      icono.textContent = (tipo === 'multiple') ? '☐' : '◯';
    }

    tipoSelect.addEventListener('change', ()=>{
      contOpc.querySelectorAll('[data-opcion-fila]').forEach(f=> aplicarIconoTipo(f));
    });

    document.getElementById('agregar-opcion').addEventListener('click', agregarOpcionFila);

    // Inicialización con dos opciones
    document.addEventListener('DOMContentLoaded', ()=>{
      agregarOpcionFila();
      agregarOpcionFila();

      document.getElementById('formulario').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const opciones = [];
        contOpc.querySelectorAll('[data-opcion-fila]').forEach(f=>{
          const txt = f.querySelector('[data-opcion-texto]').value.trim();
          if (txt) opciones.push(txt);
        });
        if (opciones.length < 2){
          alert('Agrega al menos 2 opciones.');
          return;
        }
        // Mapear a estructura de Encuesta (1 sola pregunta)
        const tipoVoto = document.getElementById('tipo-voto').value; // unica|multiple
        const tipoPregunta = tipoVoto === 'multiple' ? 'casillas' : 'opcion_multiple';
        const payload = {
          titulo: document.getElementById('titulo-vot').value || 'Votación sin título',
          descripcion: document.getElementById('descripcion-vot').value || '',
          esVotacion: true,
          preguntas: [{
            texto: document.getElementById('texto-pregunta').value || 'Pregunta',
            tipo: tipoPregunta,
            requerida: document.getElementById('requerida').checked,
            opciones: opciones.map(t=> ({ texto: t, correcta: false }))
          }]
        };
        try{
          const resp = await fetch('/api/encuestas',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
          if(!resp.ok){
            const txt = await resp.text();
            throw new Error(txt || 'Error al guardar');
          }
          const id = await resp.json();
          alert('Votación creada con ID: ' + id);
          window.location.href = '/votaciones';
        }catch(err){
          console.error(err);
          alert('No se pudo guardar la votación: ' + err.message);
        }
      });
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
