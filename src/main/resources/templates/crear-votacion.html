<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Crear Votación</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="estilos.css">
  <!-- CSRF para fetch -->
  <meta name="_csrf" th:content="${_csrf.token}">
  <meta name="_csrf_header" th:content="${_csrf.headerName}">
  <style>
    .tab-btn.active { background:#198754; color:#fff }
    .question-card{border:1.5px solid #e3e3e3;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.04);margin-bottom:1.5rem}
    .option-input{width:90%}
    .icon-btn{background:none;border:none;color:#6c757d;font-size:1.1rem;margin-left:.5rem}
    .icon-btn:hover{color:#198754}
  </style>
  
</head>
<body>
  <nav class="navbar navbar-light bg-white border-bottom">
    <div class="container-fluid">
      <a class="btn btn-outline-success" href="/votaciones"><i class="bi bi-x-lg"></i> Cerrar</a>
      <span class="navbar-brand mx-auto fw-bold" id="titulo-navbar">Crear Votación</span>
      <button class="btn btn-success" type="submit" form="formulario" id="btn-guardar"><i class="bi bi-check-lg"></i> Crear</button>
    </div>
  </nav>

  <div class="container mt-4" style="max-width:760px;">
    <ul class="nav nav-tabs mb-3">
      <li class="nav-item"><button class="nav-link tab-btn active" id="tab-preguntas" onclick="mostrarTab('preguntas')"><i class="bi bi-list-ul me-1"></i>Opciones</button></li>
      <li class="nav-item"><button class="nav-link tab-btn" id="tab-respuestas" onclick="mostrarTab('respuestas')"><i class="bi bi-bar-chart me-1"></i>Resultados</button></li>
    </ul>

    <form id="formulario">
      <div id="tab-contenido-preguntas">
        <div class="mb-4">
          <input id="titulo-vot" type="text" class="form-control form-control-lg mb-2" placeholder="Votación sin título" name="titulo">
          <textarea id="descripcion-vot" class="form-control" rows="2" placeholder="Descripción" name="descripcion"></textarea>
        </div>

        <div class="question-card p-3" id="votacion-card">
          <div class="d-flex gap-2 mb-3 align-items-start">
            <input type="text" class="form-control" placeholder="Pregunta o asunto de la votación" id="texto-pregunta">
            <select class="form-select" style="width:220px" id="tipo-voto">
              <option value="unica" selected>Respuesta única</option>
              <option value="multiple">Selección múltiple</option>
            </select>
          </div>

          <div id="opciones-contenedor"></div>

          <div class="mt-2">
            <button type="button" class="btn btn-sm btn-outline-success" id="agregar-opcion">
              <i class="bi bi-plus-lg me-1"></i>Agregar opción
            </button>
          </div>

          <div class="form-check form-switch mt-3">
            <input class="form-check-input" type="checkbox" id="requerida">
            <label class="form-check-label" for="requerida">Obligatoria</label>
          </div>
        </div>
      </div>

      <div id="tab-contenido-respuestas" style="display:none;">
        <div class="alert alert-info text-center">Aquí se mostrarán los resultados cuando la votación esté activa.</div>
      </div>
    </form>
  </div>

  <template id="tpl-opcion-fila">
    <div class="d-flex align-items-center mb-2" data-opcion-fila>
      <i class="me-2 text-muted" data-opcion-icono></i>
      <input type="text" class="form-control option-input" placeholder="Opción" data-opcion-texto>
      <button type="button" class="icon-btn" title="Eliminar opción" data-opcion-eliminar><i class="bi bi-x-lg"></i></button>
    </div>
  </template>

  <script>
    function csrfHeaders(){
      const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
      const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content') || 'X-CSRF-TOKEN';
      const h = {}; h[header] = token; return h;
    }

    function mostrarTab(tab){
      document.getElementById('tab-contenido-preguntas').style.display = tab==='preguntas'?'':'none';
      document.getElementById('tab-contenido-respuestas').style.display = tab==='respuestas'?'':'none';
      document.getElementById('tab-preguntas').classList.toggle('active',tab==='preguntas');
      document.getElementById('tab-respuestas').classList.toggle('active',tab==='respuestas');
    }

    const contOpc = document.getElementById('opciones-contenedor');
    const tipoSelect = document.getElementById('tipo-voto');

    function clonarTemplate(id){
      return document.getElementById(id).content.firstElementChild.cloneNode(true);
    }

    function agregarOpcionFila(){
      const fila = clonarTemplate('tpl-opcion-fila');
      aplicarIconoTipo(fila);
      fila.querySelector('[data-opcion-eliminar]').addEventListener('click', ()=>{
        fila.remove();
      });
      contOpc.appendChild(fila);
    }

    function aplicarIconoTipo(fila){
      const icono = fila.querySelector('[data-opcion-icono]');
      const tipo = tipoSelect.value;
      // multiple (Checkbox) -> Cuadrado, unica (Radio) -> Círculo
      icono.className = (tipo === 'multiple') ? 'bi bi-square' : 'bi bi-circle';
      icono.textContent = ''; 
    }

    tipoSelect.addEventListener('change', ()=>{
      contOpc.querySelectorAll('[data-opcion-fila]').forEach(f=> aplicarIconoTipo(f));
    });

    document.getElementById('agregar-opcion').addEventListener('click', agregarOpcionFila);

    function tipoPreguntaDesdeSelect(){
      const v = document.getElementById('tipo-voto').value;
      // Invertido: multiple -> opcion_multiple (Checkbox), unica -> casillas (Radio)
      return v === 'multiple' ? 'opcion_multiple' : 'casillas';
    }

    function selectDesdeTipoPregunta(tp){
      if (tp === 'opcion_multiple') return 'multiple';
      return 'unica';
    }

    async function cargarVotacion(id){
      const r = await fetch(`/api/votaciones/${id}`);
      if(!r.ok) throw new Error('No se pudo cargar la votación');
      const data = await r.json();
      document.getElementById('titulo-vot').value = data.titulo || '';
      document.getElementById('descripcion-vot').value = data.descripcion || '';
      const pregunta = (data.preguntas && data.preguntas[0]) || null;
      if (pregunta){
        document.getElementById('texto-pregunta').value = pregunta.texto || '';
        document.getElementById('tipo-voto').value = selectDesdeTipoPregunta(pregunta.tipo || 'opcion_multiple');
        document.getElementById('requerida').checked = !!pregunta.requerida;
        contOpc.innerHTML = '';
        (pregunta.opciones || []).forEach(op=>{
          agregarOpcionFila();
          const fila = contOpc.lastElementChild;
          if (fila){ fila.querySelector('[data-opcion-texto]').value = op.texto || ''; }
        });
        if (contOpc.children.length === 0){ agregarOpcionFila(); agregarOpcionFila(); }
      } else {
        contOpc.innerHTML = '';
        agregarOpcionFila(); agregarOpcionFila();
      }
    }

    document.addEventListener('DOMContentLoaded', async ()=>{
      const params = new URLSearchParams(window.location.search);
      const idEditar = params.get('id');
      if (idEditar){
        document.getElementById('titulo-navbar').textContent = 'Editar Votación';
        document.getElementById('btn-guardar').innerHTML = '<i class="bi bi-check-lg"></i> Guardar';
        try{
          await cargarVotacion(idEditar);
        }catch(err){
          console.error(err);
          alert('Error cargando la votación: ' + err.message);
        }
      } else {
        agregarOpcionFila();
        agregarOpcionFila();
      }

      document.getElementById('formulario').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const opciones = [];
        contOpc.querySelectorAll('[data-opcion-fila]').forEach(f=>{
          const txt = f.querySelector('[data-opcion-texto]').value.trim();
          if (txt) opciones.push(txt);
        });
        if (opciones.length < 2){
          alert('Agrega al menos 2 opciones.');
          return;
        }
        const payload = {
          titulo: document.getElementById('titulo-vot').value || 'Votación sin título',
          descripcion: document.getElementById('descripcion-vot').value || '',
          esVotacion: true,
          preguntas: [{
            texto: document.getElementById('texto-pregunta').value || 'Pregunta',
            tipo: tipoPreguntaDesdeSelect(),
            requerida: document.getElementById('requerida').checked,
            opciones: opciones.map(t=> ({ texto: t, correcta: false }))
          }]
        };
        try{
          const idEd = (new URLSearchParams(window.location.search)).get('id');
          const url = idEd ? `/api/votaciones/${idEd}` : '/api/votaciones';
          const method = idEd ? 'PUT' : 'POST';
          const resp = await fetch(url,{
            method,
            headers:Object.assign({'Content-Type':'application/json'}, csrfHeaders()),
            body: JSON.stringify(payload)
          });
          if(!resp.ok){
            const txt = await resp.text();
            throw new Error(txt || 'Error al guardar');
          }
          if (idEd){
            alert('Votación actualizada correctamente');
          } else {
            const id = await resp.json();
            alert('Votación creada con ID: ' + id);
          }
          window.location.href = '/votaciones';
        }catch(err){
          console.error(err);
          alert('No se pudo guardar la votación: ' + err.message);
        }
      });
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
