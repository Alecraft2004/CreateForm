<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Participar en Encuesta</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/estilos.css" th:href="@{/css/estilos.css}">
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-white">
    <div class="container">
      <a class="navbar-brand fw-bold" href="/">
        <i class="bi bi-bar-chart-line-fill me-2"></i>
        Encuestas y Votaciones
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="/index">Inicio</a></li>
          <li class="nav-item"><a class="nav-link active" href="/encuestas">Encuestas</a></li>
          <li class="nav-item"><a class="nav-link" href="/votaciones">Votaciones</a></li>
          <li class="nav-item" sec:authorize="!isAuthenticated()"><a class="nav-link" href="/login">Iniciar Sesión</a></li>
          <li class="nav-item" sec:authorize="!isAuthenticated()"><a class="nav-link" href="/register">Registrarse</a></li>
          <li class="nav-item dropdown" sec:authorize="isAuthenticated()">
            <a class="nav-link dropdown-toggle" href="#" id="userMenu" role="button" data-bs-toggle="dropdown" aria-expanded="false"
               th:text="${usuarioActual != null ? usuarioActual.nombre : #authentication.name}">Usuario</a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenu">
              <li class="dropdown-item-text small text-muted" th:text="${#authentication.name}">usuario@correo</li>
              <li><hr class="dropdown-divider"></li>
              <li>
                <form th:action="@{/logout}" method="post">
                  <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                  <button class="dropdown-item" type="submit"><i class="bi bi-box-arrow-right me-1"></i> Cerrar sesión</button>
                </form>
              </li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container mb-5 mt-4">
    <div id="loading" class="text-center">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
    </div>
    
    <div id="encuesta-container" style="display:none;">
        <div class="card shadow-sm mb-4">
            <div class="card-body p-5">
                <h1 class="display-6 fw-bold mb-3" id="titulo-encuesta"></h1>
                <p class="lead text-muted" id="descripcion-encuesta"></p>
            </div>
        </div>

        <form id="form-participacion">
            <div id="preguntas-container"></div>
            
            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                <a href="/encuestas" class="btn btn-outline-secondary me-md-2">Cancelar</a>
                <button type="submit" class="btn btn-primary btn-lg px-5">Enviar Respuestas</button>
            </div>
        </form>
    </div>
  </div>

  <input type="hidden" id="encuestaId" th:value="${encuestaId}">
  <input type="hidden" id="csrfToken" th:value="${_csrf.token}">

  <script>
    const encuestaId = document.getElementById('encuestaId').value;
    const csrfToken = document.getElementById('csrfToken').value;

    async function cargarEncuesta() {
        try {
            const res = await fetch(`/api/encuestas/${encuestaId}`);
            if (!res.ok) throw new Error('Error al cargar encuesta');
            const data = await res.json();
            
            document.getElementById('titulo-encuesta').textContent = data.titulo;
            document.getElementById('descripcion-encuesta').textContent = data.descripcion;
            
            const container = document.getElementById('preguntas-container');
            container.innerHTML = ''; // Limpiar contenedor
            data.preguntas.forEach((p, index) => {
                const card = document.createElement('div');
                card.className = 'card mb-3 shadow-sm';
                let inputHtml = '';
                
                if (p.tipo === 'corta') {
                    inputHtml = `<input type="text" class="form-control" name="p_${p.id}" required>`;
                } else if (p.tipo === 'parrafo') {
                    inputHtml = `<textarea class="form-control" name="p_${p.id}" rows="3" required></textarea>`;
                } else if (p.tipo === 'opcion_multiple') {
                    p.opciones.forEach(op => {
                        inputHtml += `
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="p_${p.id}" value="${op.id}" id="op_${op.id}" required>
                                <label class="form-check-label" for="op_${op.id}">${op.texto}</label>
                            </div>`;
                    });
                } else if (p.tipo === 'casillas') {
                    p.opciones.forEach(op => {
                        inputHtml += `
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="p_${p.id}" value="${op.id}" id="op_${op.id}">
                                <label class="form-check-label" for="op_${op.id}">${op.texto}</label>
                            </div>`;
                    });
                } else if (p.tipo === 'desplegable') {
                    inputHtml = `<select class="form-select" name="p_${p.id}" required>
                        <option value="" selected disabled>Selecciona una opción</option>`;
                    p.opciones.forEach(op => {
                        inputHtml += `<option value="${op.id}">${op.texto}</option>`;
                    });
                    inputHtml += `</select>`;
                }

                card.innerHTML = `
                    <div class="card-body">
                        <h5 class="card-title mb-3">${index + 1}. ${p.texto}</h5>
                        ${inputHtml}
                    </div>
                `;
                container.appendChild(card);
            });

            document.getElementById('loading').style.display = 'none';
            document.getElementById('encuesta-container').style.display = 'block';
        } catch (err) {
            alert('No se pudo cargar la encuesta.');
            console.error(err);
        }
    }

    document.getElementById('form-participacion').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const respuestas = [];
        
        const cards = document.querySelectorAll('#preguntas-container .card');
        cards.forEach(card => {
            const inputs = card.querySelectorAll('input, textarea, select');
            if (inputs.length === 0) return;
            
            const name = inputs[0].name; // p_{id}
            const pId = parseInt(name.split('_')[1]);
            
            const type = inputs[0].type;
            const tagName = inputs[0].tagName.toLowerCase();
            
            if (type === 'radio') {
                const checked = card.querySelector(`input[name="${name}"]:checked`);
                if (checked) {
                    respuestas.push({ preguntaId: pId, opcionId: parseInt(checked.value) });
                }
            } else if (type === 'checkbox') {
                const checked = card.querySelectorAll(`input[name="${name}"]:checked`);
                checked.forEach(c => {
                    respuestas.push({ preguntaId: pId, opcionId: parseInt(c.value) });
                });
            } else if (tagName === 'select') {
                const val = inputs[0].value;
                if (val) {
                    respuestas.push({ preguntaId: pId, opcionId: parseInt(val) });
                }
            } else {
                const val = inputs[0].value;
                if (val) {
                    respuestas.push({ preguntaId: pId, texto: val });
                }
            }
        });

        try {
            const res = await fetch(`/api/encuestas/${encuestaId}/participar`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-XSRF-TOKEN': csrfToken
                },
                body: JSON.stringify({ respuestas })
            });
            
            if (res.ok) {
                alert('¡Gracias por participar!');
                window.location.href = '/encuestas';
            } else {
                let msg = 'Error desconocido';
                try {
                    msg = await res.text();
                    if (msg.trim().startsWith('<')) {
                        msg = 'Error del servidor (' + res.status + ')';
                    }
                } catch (e) {}
                alert('Error al enviar respuestas: ' + msg);
            }
        } catch (err) {
            console.error(err);
            alert('Error de conexión.');
        }
    });

    document.addEventListener('DOMContentLoaded', cargarEncuesta);
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
